%%
%   Mark Tentindo
%   ECE 6565
%   2014-10-03
%   Final Project
%%

function [appNames, appFingerprints] = parse_files(directory, regexStrings)

    % create a list of file names to scan
    appNames = ls(directory);
    appNames = appNames(3:end, :);
    [numNames, ~] = size(appNames);
    
    if (length(appNames) <= 0)
        error('No files in <%s>', directory)
    end
    
    % scrape targeted API calls from each file
    rootDir = pwd;
    cd(directory)

    appFingerprints = zeros(numNames, length(regexStrings));
    
    for currentApp = 1:numNames
        
        % open file
        file = fopen(appNames(currentApp, :), 'r');
        if (file == -1)
            error('Unable to open file <%s>', appNames(currentApp, :))
        end
        
        % scrape app's api calls
        line = fgets(file);
        line = strrep(line, ', ', '' );
        callNames = textscan(line, '%s', 'Delimiter', ',', 'BufSize', 100000);
        callNames = callNames{1};
        callNames = callNames(2:end); % remove time column heading

        % close file
        if(fclose(file) == -1)
            error('Unable to close file <%s>', appNames(currentApp, :))
        end
        
        % scrape the number of times each call occurs
        callCounts = csvread(appNames(currentApp, :), 1, 1); % ignore headings and times
        callCounts = sum(callCounts);
        
%         L1 = length(callCounts)
%         L2 = length(callNames)
%         
%         if(length(callCounts) ~= length(callNames))
%             error('Lengths of callCounts and callNames do not match for <%s>', appNames(currentApp, :))
%         end
        
        % generate app fingerprint
        appFingerprints(currentApp, :) = check_api_lib(callNames, callCounts, regexStrings);
        
    end
    
    cd(rootDir)

end

% This function determines the number of times a targeted call
% was made by the app under analysis

function [appFingerprint] = check_api_lib(callNames, callCounts, regexStrings)

    appFingerprint = zeros(1, length(regexStrings));
    
    for regexIndex = 1:length(regexStrings)   
        for callIndex = 1:length(callNames)
            if(strfind(callNames{callIndex}, regexStrings{regexIndex}))
                appFingerprint(regexIndex) = callCounts(callIndex);
                break
            end
        end
    end
end
    